name: Tagging
on:
  workflow_run:
    workflows:
      - CI
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

jobs:
  tagging:
    runs-on: ubuntu-latest
    if: ${{ contains(github.ref, 'main') && github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Set Tag Value
        run: |
          echo "DATE=v$(echo `date +'%Y.%m'`)" >> $GITHUB_ENV
      - name: Create tag
        uses: actions/github-script@v6
        if: ${{ env.DATE }}
        with:
          github-token: ${{ github.token }}
          script: |
            let tagExists = [];
            const commit = await github.rest.repos.getCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'main'
            });
            try {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: "refs/tags/${{ env.DATE }}",
                sha: commit.data.sha.toString()
              });
            } catch (e) {
              console.log("Tag already exists: " + e)
              tagExists.push(e);
            }

            if (tagExists.length > 0) {
              await github.rest.git.updateRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: "tags/${{ env.DATE }}",
                sha: commit.data.sha.toString(),
                force: true
              });
            }
